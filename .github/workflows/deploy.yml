name: Deploy - behind_proxy

on:
  push:
    branches: [ behind_proxy ]
  pull_request:
    branches: [ behind_proxy ]
  workflow_dispatch:

jobs:
  server_prep:
    name: Prepare infra on server
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Stop and delete all containers
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        script: |
          set +e
          docker ps -aq | xargs -r docker stop
          docker ps -aq | xargs -r docker rm
          set -e

    - name: Certbot and Nginx setup
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        script: |
          set -e
          sudo mkdir -p /var/www/certbot
          sudo chown -R www-data:www-data /var/www/certbot
          sudo nano /etc/nginx/sites-available/certbot-challenge
          sudo mkdir -p /etc/nginx/sites-available/ && \
          echo ${{ secrets.NGINX_TMP_CONFIG }} | sudo tee /etc/nginx/sites-available/certbot-challenge >/dev/null
          sudo ln -s /etc/nginx/sites-available/certbot-challenge /etc/nginx/sites-enabled/
          sudo nginx -t && sudo systemctl reload nginx

    - name: Obtain SSL Certificates
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        script: |
          set -e
          sudo certbot certonly --webroot \
            -w /var/www/certbot \
            -d cloud.${{ secrets.HOST }} \
            -d collabora.${{ secrets.HOST }} \
            -d wopiserver.${{ secrets.HOST }} \
            --email ${{ secrets.TRAEFIK_ACME_MAIL }} \
            --agree-tos \
            --no-eff-email

    - name: Create projects directories
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        script: |
          set -e
          sudo rm -rf opencloud-compose || true
          sudo mkdir -p opencloud-compose
          sudo chown -R ${{ secrets.USER }}:${{ secrets.USER }} opencloud-compose
          sudo chmod -R 755 opencloud-compose
          sudo mkdir -p opencloud-compose/{config,data}
          sudo chown -R 1000:1000 opencloud-compose

    - name: Copy project files
      shell: bash
      run: |
        set -e
        sshpass -p "${{ secrets.SSH_PASSWORD }}" scp -v -o StrictHostKeyChecking=no \
            -r . \
            ${{ secrets.USER }}@${{ secrets.HOST }}:/${{ secrets.USER }}/opencloud-compose

    - name: Create environment file
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        script: |
          set -e
          cd opencloud-compose
          if [ -f .env.example ]; then
            cp .env.example .env
            echo "OC_DOMAIN=cloud.${{ secrets.HOST }}" >> .env
            echo "TRAEFIK_DOMAIN=traefik.${{ secrets.HOST }}" >> .env
            echo "COLLABORA_DOMAIN=collabora.${{ secrets.HOST }}" >> .env
            echo "WOPISERVER_DOMAIN=wopiserver.${{ secrets.HOST }}" >> .env
            echo "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" >> .env
            echo "INITIAL_ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" >> .env
            echo "TRAEFIK_ACME_MAIL=${{ secrets.TRAEFIK_ACME_MAIL }}" >> .env
            echo "Environment file created and configured"
          else
            echo ".env.example not found, skipping .env creation"
            exit 1
          fi

  deploy:
    runs-on: ubuntu-latest
    needs:
      - server_prep
    outputs:
      container_status: ${{ steps.get_status.outputs.status }}
    steps:
    - name: Deploy containers
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        script: |
          set -e
          cd opencloud-compose
          docker compose up -d

    - name: Get container status
      id: get_status
      run: |
        sleep 15
        status=$(sshpass -p "${{ secrets.SSH_PASSWORD }}" ssh -o StrictHostKeyChecking=no \
          ${{ secrets.USER }}@${{ secrets.HOST }} \
          "docker ps -a --format 'table {{.Names}}\t{{.Status}}'")
        echo "status<<EOF" >> $GITHUB_OUTPUT
        echo "$status" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
  
  reverse_proxy_setup:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Replace tmp nginx config
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            sudo rm /etc/nginx/sites-enabled/certbot-challenge
            sudo nano /etc/nginx/sites-available/opencloud
            echo ${{ secrets.NGINX_CONFIG }} | sudo tee /etc/nginx/sites-available/opencloud >/dev/null

      - name: Enable and reload Nginx
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            sudo ln -s /etc/nginx/sites-available/opencloud /etc/nginx/sites-enabled/
            sudo nginx -t && sudo systemctl reload nginx

      - name: Test Certificate Renewal
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          script: |
            set -e
            sudo certbot renew --dry-run

  send_message:
    runs-on: ubuntu-latest
    needs: [deploy, reverse_proxy_setup]
    if: always()
    steps:
    - name: send message
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_TO }}
        token: ${{ secrets.TELEGRAM_TOKEN }}
        format: markdown
        message: |
          *${{ github.workflow }}*
          –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: \`${{ github.repository }}\`
          ```
          ${{ needs.deploy.outputs.container_status || '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å' }}
          ```
          üîó https://cloud.${{ secrets.HOST }}
